<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <!-- JQuery -->
    <script crossorigin="anonymous"
            integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <!-- Bootstrap core CSS -->
    <link crossorigin="anonymous" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
          integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" rel="stylesheet">
    <!--ref to css-->
    <!--    <script src="{{ url_for('static', filename='functionality.js') }}" type="text/javascript"></script>-->
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script src="https://d3js.org/topojson.v1.min.js"></script>
    <script src="//maps.googleapis.com/maps/api/js?"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/4.2.2/d3.min.js"></script>
    <script type="text/javascript" src="http://code.jquery.com/jquery-1.8.1.min.js"></script>
    <link href="{{ url_for('static', filename='style.css') }}" rel="stylesheet">
    <style>
      #svg1 {
      width: 1100;
      height: 600;
      margin: 0;
      padding: 0;
      }
      .stations, .stations svg {
      position: absolute;
      }
      .stations line {
      position: relative;
      stroke: black;
      stroke-width: 2px;
      }
      .links {
      //width: 100%;
      //height: 100%;
      position: relative;
      }
      .stations circle {
      fill: brown;
      stroke: black;
      stroke-width: 1.5px;
      }
      .stations svg {
      width: 1000px;
      height: 1500px;
      padding-right: 100px;
      font: 10px sans-serif;
      }
      #toggle {
      position: absolute;
      right: 15px; top: 15px;
      z-index: 100;
      }
      .map path {
      fill: #eee;
      stroke: #fff;
      stroke-width: 2;
      }
      .container-fluid {
      overflow: hidden;
      }
      .links line {
      stroke: red;
      stroke-opacity: 0.25;
      }
      .nodes circle {
      fill: #679;
      stroke: #235;
      stroke-width: 1.5;
      }
      div.tooltip {
      color: #222;
      background: #fff;
      border-radius: 3px;
      box-shadow: 0px 0px 2px 0px #a6a6a6;
      padding: .2em;
      text-shadow: #f5f5f5 0 1px 0;
      opacity: 0.9;
      position: fixed;
      }
      .background {
      fill: none;
      pointer-events: all;
      }
      #states {
      fill: #aaa;
      }
      #state-borders {
      fill: none;
      stroke: #000;
      stroke-width: 1.5px;
      stroke-linejoin: round;
      stroke-linecap: round;
      pointer-events: none;
      }
    </style>
</head>
<body>
<div class="form-popup" id="myFormAN">
    <form class="form-container" onsubmit="return false;">
        <h1>Add IXP Node</h1>
        <label for="Latitude1"><b>IXP Latitude</b></label>
        <input id="LatName1" placeholder="Enter IXP Latitude" required type="text">
        <label for="Longitude1"><b>IXP Longitude</b></label>
        <input id="LongT1" placeholder="Enter IXP Longitude" required type="text">
        <button class="btn" onclick="addIXPNode()" type="submit">Add IXP Node</button>
        <button class="btn cancel" onclick="closeFormAN()" type="button">Close</button>
    </form>
</div>

<div class="form-popup" id="myFormDN">
    <form class="form-container" onsubmit="return false;">
        <h1>Delete Node</h1>
        <label for="Latitude1"><b>IXP Latitude</b></label>
        <input id="NodeLat1" placeholder="Enter Node Latitude" required type="text">
        <label for="Longitude1"><b>IXP Longitude</b></label>
        <input id="NodeLongT1" placeholder="Enter Node Longitude" required type="text">
        <button class="btn" onclick="deleteNode()" type="submit">Delete Node</button>
        <button class="btn cancel" onclick="closeFormDN()" type="button">Close</button>
    </form>
</div>
<div class="form-popup" id="myFormAC">
    <form class="form-container" onsubmit="return false;">
        <h1>Add Connection</h1>
        <label for="Location1"><b>Location 1</b></label>
        <input id="Location1" placeholder="Location1" required type="text">
        <label for="Location2"><b>Location 2</b></label>
        <input id="Location2" placeholder="Location2" required type="text">
        <button class="btn" onclick="addConnection()" type="submit">Add connection</button>
        <button class="btn cancel" onclick="closeFormAC()" type="button">Close</button>
    </form>
</div>

<div class="form-popup" id="myFormDC">
    <form class="form-container" onsubmit="return false;">
        <h1>Remove Connection</h1>
        <label for="Location1"><b>Location 1</b></label>
        <input id="Loc1" placeholder="Location1" required type="text">
        <label for="Location2"><b>Location 2</b></label>
        <input id="Loc2" placeholder="Location2" required type="text">
        <button class="btn" onclick="addConnection()" type="submit">Add connection</button>
        <button class="btn cancel" onclick="closeFormDC()" type="button">Close</button>
    </form>
</div>
<!-- <div id="map"></div> -->
<div class="d-flex align-items-start" id="wrapper">
    <div class="bg-light border-right" id="sidebar-wrapper">
        <div class="sidebar-heading">Menu</div>
        <div class="list-group list-group-flush">
            <button class="list-group-item list-group-item-action bg-light" href="#" id="addN" onclick="openFormAN()">
                Add IXP Node
            </button>
            <button class="list-group-item list-group-item-action bg-light" href="#" id="addC" onclick="openFormAC()">
                Add Connection
            </button>
            <button class="list-group-item list-group-item-action bg-light" href="#" id="deleteNode"
                    onclick="openFormDN()">Delete Node
            </button>
            <button class="list-group-item list-group-item-action bg-light" href="#" id="deleteCon"
                    onclick="openFormDC()">Delete Connection
            </button>
        </div>
    </div>
    <!-- Page Content -->
    <div id="page-content-wrapper">
        <nav class="navbar navbar-expand-lg navbar-light bg-light border-bottom">
            <ul class="navbar-nav mr-auto mt-2 mt-lg-0">
                <li class="nav-item active">
                    <button class="btn btn-primary" id="menu-toggle1">Toggle Menu</button>
                    <button class="btn btn-primary" id="menu-toggle" onclick="openForm()">Simulation</button>
                    <button class="btn btn-secondary" id="clear-graph" onclick="clearGraph()">Clear Graph</button>
                    <button id="toggle">start simulation</button>
                </li>
            </ul>
        </nav>
        <div class="container-fluid" id="tooltip">
            <div id="map" style="width:100%;height:500px;"></div>
        </div>
    </div>
    <!-- /#page-content-wrapper -->
</div>
<!-- /#wrapper -->
<!-- <script src="https://unpkg.com/topojson@3/dist/topojson.min.js"></script> -->
<script>
      // Create the Google Mapâ€¦

      var nodes = [];
var links = [];
dichild = document.getElementById("map");
console.log(dichild);
var map = new google.maps.Map(document.getElementById('map'), {
    zoom: 3,
    center: new google.maps.LatLng(34.5085, 8.7832),
    //mapTypeId: google.maps.MapTypeId.TERRAIN
});

// Load the station data. When the data comes back, create an overlay.
d3.csv("static/asn_loc.csv", function(data) {
    nodes.push(data);
    console.log(data);
    console.log("hry");
    //draw(data)

    d3.csv("static/asn_links.csv", function(datalinks) {
    links.push(datalinks);
    console.log(links);

    draw(data,datalinks);
    console.log(nodes);
    });

});

d3.csv("static/asn_links.csv", function(data) {
});




console.log(links);


console.log(nodes)
var k;

var nodes_red = [] //Nodes Array

function draw(data,datalinks) {
  //console.log(datalinks);
  //console.log(data);
      var b;
      for(b =0; b<data.length; b++){
            var lat= data[b].Latitude;
            var long= data[b].Longitude;
            var latLng = {lat: parseFloat(lat), lng: parseFloat(long)};
            nodes[b] = latLng;
            var  asnnumber = data[b].ASN;
            var newnode = new Node(asnnumber,latLng);
            nodes_red.push(newnode);
            var marker = new google.maps.Marker({
            position: latLng,
            sName: data[b].ASN,
            map: map,
            icon: {
                path: google.maps.SymbolPath.CIRCLE,
                scale: 2.5,
                fillColor: "#F00",
                fillOpacity: 0.4,
                strokeWeight: 0.4
            },
        });

       // console.log("Am here");
      }
      console.log(nodes);
     // console.log(datalinks);
      var p;
      for(p=0; p<datalinks.length; p++){
      var source; var target; var j;

           for(j=0; j<nodes_red.length;j++){
             console.log("nikooona");
                if(datalinks[p].Source == nodes_red[j].asn_number){
                  source = nodes_red[j].pos;
                //  console.log(source)
                }

                    if(datalinks[p].Target == nodes_red[j].asn_number){
                      target = nodes_red[j].pos;
                    }

           }

          // console.log(source);
           //console.log(target);

            var flightPlanCoordinates = [
                source,target
              ];
              var flightPath = new google.maps.Polyline({
                path: flightPlanCoordinates,
                geodesic: true,
                strokeColor: '#FF0000',
                strokeOpacity: 1.0,
                strokeWeight: 1
              });

              flightPath.setMap(map);


      }


  }

  function animateCircle(line) {
    var count = 0;
    window.setInterval(function() {
      count = (count + 1) % 200;

      var icons = line.get('icons');
      icons[0].offset = (count / 2) + '%';
      line.set('icons', icons);
  }, 20);
}

function openFormAC() {
    document.getElementById("myFormAC").style.display = "block";
}

function closeFormAC() {
    document.getElementById("myFormAC").style.display = "none";
}
function openFormAN() {
    document.getElementById("myFormAN").style.display = "block";
}

function closeFormAN() {
    document.getElementById("myFormAN").style.display = "none";
}
function openFormDC() {
    document.getElementById("myFormDC").style.display = "block";
}
function closeFormDC() {
    document.getElementById("myFormDC").style.display = "none";
}

function openFormDN() {
    document.getElementById("myFormDN").style.display = "block";
}
function closeFormDN() {
    document.getElementById("myFormDN").style.display = "none";
}

function addIXPNode() {
    var lati = document.getElementById("LatName1").value;
    var long = document.getElementById("LongT1").value;
    console.log(lati)
    console.log(long)
    newNode = {
        Name: "IXP",
        Long: parseFloat(long),
        Lat: parseFloat(lati)
    }
     var latLng = {lat: parseFloat(lati), lng: parseFloat(long)};
     nodes.push(latLng);
     var letter = String.fromCharCode("X".charCodeAt(0));
      var iconBase = 'https://maps.google.com/mapfiles/kml/shapes/';
      var marker = new google.maps.Marker({
            position: latLng,
            sName: newNode.ASN,
            map: map,
            icon: "http://maps.google.com/mapfiles/marker" + letter + ".png",
            scale: 1.5
        });

        console.log(nodes);



}

function addConnection() {
    var location1 = document.getElementById("Location1").value;
    var location2 = document.getElementById("Location2").value;
    console.log(location1);
    console.log(location2);

    var loc1 = location1.split(',');
    var loc2 = location2.split(',');

    var latLng1 = {lat: parseFloat(loc1[0]), lng: parseInt(loc1[1])};
    var latLng2 = {lat: parseFloat(loc2[0]), lng: parseInt(loc2[1])};
    console.log(findNode(loc1[0],loc1[1]));
    console.log(findNode(loc2[0],loc2[1]));
    if(findNode(loc1[0],loc1[1]) && findNode(loc2[0],loc2[1])){

     var flightPlanCoordinates = [
                latLng1,latLng2
              ];
              var flightPath = new google.maps.Polyline({
                path: flightPlanCoordinates,
                geodesic: true,
                strokeColor: '#008000',
                strokeOpacity: 1.0,
                strokeWeight: 1
              });

              flightPath.setMap(map);

       }

       else {
        alert("Nodes not already added. Add the nodes first to proceed.");
       }

}

function findNode(lat,long){
    for (let index = 0; index < nodes.length; index++) {
     // console.log("Am in here300000000");
        //console.log(nodes[index].id);//trace
        //console.log(id.lat)
        //console.log(nodes[index])
        var values = Object.values(nodes[index]);
        //console.log(values)
        if(values[0] == lat && values[1] == long) {
            return true;
            break;
        }
    }
    return false;
}

function deleteNode(){
console.log(nodes);
 var lati = document.getElementById("NodeLat1").value;
 var long = document.getElementById("NodeLongT1").value;
  if(findNode(lati,long)){
    for (let index = 0; index < nodes.length; index++) {
     // console.log("Am in here300000000");
        //console.log(nodes[index].id);//trace
        //console.log(id.lat)
        //console.log(nodes[index])
        var values = Object.values(nodes[index]);
        //console.log(values)
        if(values[0] == lati && values[1] == long) {
            //console.log(index);
           // delete nodes[index];
            console.log(nodes.splice(index,1));
            console.log(nodes);
        }
    }

  }
  else {
        alert("Nodes not already added. Add the nodes first to proceed.");
        }

}

class Node {
    constructor(asn_number, pos) {
        this.asn_number = asn_number;
        this.pos = pos;
    }
}

class Link {
    constructor(node1, node2) {
        this.source = node1;
        this.target = node2;
    }
}

<!--            var positioning = 'map'-->
<!--            var margin = { top:50, left:50, right:50, bottom:50},-->
<!--            height = 600 - margin.top - margin.bottom,-->
<!--            width = 1600 - margin.left - margin.right;-->


<!--            var projection = d3.geoMercator()-->
<!--                .center([0, 0 ])-->
<!--                .scale(150)-->
<!--                //.translate([width/2,height/2])-->

<!--            divChild = document.getElementById("svg1");-->
<!--            var svg = d3.select(divChild)-->
<!--                .append('svg')-->
<!--                .attr('width', width)-->
<!--                .attr('height', height)-->

<!--            var map = svg.append('g')-->

<!--            var path = d3.geoPath()-->
<!--                .projection(projection)-->



<!--            var linkForce = d3.forceLink()-->
<!--                .id(function (d) { return d.Name })-->
<!--                .distance(10)-->

<!--            var simulation = d3.forceSimulation()-->
<!--                .force('link', linkForce)-->
<!--                .force('charge', d3.forceManyBody()) //.strength(-160))-->
<!--                //.force('center', d3.forceCenter(width / 2, height / 2))-->
<!--                .stop()-->



<!--            var tooltip = d3.select("div.tooltip");-->

<!--            d3.queue()-->
<!--                .defer(d3.json,"static/world.json") //0-->
<!--                .defer(d3.csv, "static/world-country-names.csv") //1-->
<!--                .defer(d3.csv,"static/asn_loc.csv")  //2-->
<!--                .defer(d3.csv,"static/asn_links.csv")  //3-->
<!--                .awaitAll(ready)-->

<!--            function ready(error,data){-->
<!--                if (error) { throw error }-->

<!--                var temp = data[2]-->
<!--                var graph_nodes = [];-->
<!--                for (x of temp) {-->
<!--                    asn = {Name: parseInt(x.ASN), Long: parseFloat(x.Longitude), Lat: parseFloat(x.Latitude)}-->
<!--                    graph_nodes.push(asn)-->

<!--                }-->

<!--                temp = data[3]-->
<!--                var graph_links = [];-->
<!--                var counter = 0;-->
<!--                source = []-->
<!--                var s1 = ""-->
<!--                var t1 = ""-->
<!--                target = []-->
<!--                for( x of temp){-->
<!--                    for(p of graph_nodes){-->
<!--                        if (p.Name == x.Source) {-->
<!--                            source = [p.Long, p.Lat]-->
<!--                            s1 = parseInt(p.Name)-->
<!--                            counter += 1;-->
<!--                        }-->
<!--                        if (p.Name == x.Target) {-->
<!--                            target = [p.Long, p.Lat]-->
<!--                            t1 = parseInt(p.Name)-->
<!--                            counter += 1;-->
<!--                        }-->
<!--                        if (counter==2){-->
<!--                            //topush = {type: "LineString", coordinates: [source, target]}-->
<!--                            linked = {source: parseInt(s1), target: parseInt(t1), count: 0.5}-->
<!--                            graph_links.push(linked)-->
<!--                            counter = 0-->
<!--                            break-->
<!--                        }-->

<!--                    }-->
<!--                    counter = 0-->


<!--                }-->
<!--                console.log(graph_links)-->
<!--                var countries1 = topojson.feature(data[0], data[0].objects.countries).features-->
<!--                countries = countries1.filter(function(d) {-->
<!--                return data[1].some(function(n) {-->
<!--                  if (d.id == n.id) return d.name = n.name;-->
<!--                })});-->


<!--                 simulation-->
<!--                   .nodes(graph_nodes)-->
<!--                   .on('tick', ticked)-->
<!--                   .force('link')-->
<!--                   .links(graph_links)-->


<!--                 map.attr('class', 'map')-->
<!--                    .selectAll('path')-->
<!--                    .data(countries)-->
<!--                    .enter().append('path')-->
<!--                    .attr('d', path)-->
<!--                    .on("mouseover",function(d,i){-->
<!--                        d3.select(this).classed("selected",true)-->
<!--                        return tooltip.style("hidden", false).html(d.name);-->
<!--                    })-->
<!--                    .on("mousemove",function(d){-->
<!--                        tooltip.classed("hidden", false)-->
<!--                               .style("top", (d3.event.pageY) + "px")-->
<!--                               .style("left", (d3.event.pageX + 10) + "px")-->
<!--                               .html(d.name);-->
<!--                    })-->
<!--                    .on("mouseout",function(d,i){-->
<!--                        d3.select(this).classed("selected",false)-->
<!--                        tooltip.classed("hidden", true);-->
<!--                    });-->




<!--                //console.log(links)-->
<!--                var links = svg.append('g')-->
<!--                    .attr('class', 'links')-->
<!--                    .selectAll('line')-->
<!--                    .data(graph_links)-->
<!--                    .enter().append('line')-->
<!--                    .attr('stroke-width', function (d) { return d.count })-->

<!--                var drag = d3.drag()-->
<!--                    .on('start', dragstarted)-->
<!--                    .on('drag', dragged)-->
<!--                    .on('end', dragended)-->

<!--                var nodes = svg.append('g')-->
<!--                    .attr('class', 'nodes')-->
<!--                    .selectAll('circle')-->
<!--                    .data(graph_nodes)-->
<!--                    .enter().append('circle')-->
<!--                    .attr('r', 1.5)-->
<!--                    .attr("cx",function(d) {-->
<!--                        //console.log(d)-->
<!--                        var coord = projection([d.Long,d.Lat]) //feeding lat and long to mecator to convert it to somethin we can see-->
<!--                        return coord[0];-->
<!--                    })-->
<!--                    .attr("cy",function (d) {-->
<!--                        var coord = projection([d.Long,d.Lat]) //feeding lat and long to mecator to convert it to somethin we can see-->
<!--                        return coord[1];-->
<!--                    })-->
<!--                    .call(drag)-->

<!--                nodes.append("title")-->
<!--                        .text(function(d) { return d.Name; })-->

<!--                var zoom = d3.zoom()-->
<!--                      .on("zoom",function() {-->
<!--                        map.selectAll('path')-->
<!--                         .attr('transform', d3.event.transform);-->
<!--                        svg.selectAll("circle")-->
<!--                         .attr('transform', d3.event.transform);-->
<!--                        svg.selectAll('line')-->
<!--                          .attr("transform", d3.event.transform)-->
<!--                        //svg.attr0("transform", d3.event.transform)-->
<!--                      });-->


<!--                fixed(true)-->
<!--                d3.select('#toggle').on('click', toggle)-->
<!--                //d3.select('#menu-toggle1').on('click',function(e) {-->
<!--                //        e.preventDefault();-->
<!--                //        console.log("hey")-->
<!--                //        divChild2 = document.getElementById("#wrapper");-->
<!--                //        $(divChild2).toggleClass("toggled");-->
<!--                //      });-->
<!--                 //toggle)-->

<!--                function fixed(immediate) {-->
<!--                    graph_nodes.forEach(function (d) {-->
<!--                        var pos = projection([d.Long,d.Lat])-->
<!--                        d.x = pos[0]-->
<!--                        d.y = pos[1]-->
<!--                    })-->

<!--                    var t = d3.transition()-->
<!--                        .duration(immediate ? 0 : 600)-->
<!--                        .ease(d3.easeElastic.period(0.5))-->

<!--                    update(links.transition(t), nodes.transition(t))-->
<!--                }-->

<!--                function ticked() {-->

<!--                    update(links, nodes)-->
<!--                }-->

<!--                function update(links, nodes) {-->

<!--                    links-->
<!--                        .attr('x1', function (d) {-->
<!--                            return d.source.x })-->
<!--                        .attr('y1', function (d) {-->
<!--                            return d.source.y })-->
<!--                        .attr('x2', function (d) {-->
<!--                            return d.target.x })-->
<!--                        .attr('y2', function (d) {-->
<!--                            return d.target.y })-->

<!--                    nodes-->
<!--                        .attr('cx', function (d) {-->

<!--                            return d.x })-->
<!--                        .attr('cy', function (d) { return d.y })-->
<!--                }-->

<!--                function toggle() {-->
<!--                    if (positioning === 'map') {-->
<!--                        positioning = 'sim'-->
<!--                        //map.attr('opacity', 0.25)-->
<!--                        simulation.alpha(0).restart()-->
<!--                    } else {-->
<!--                        positioning = 'map'-->
<!--                        //map.attr('opacity', 1)-->
<!--                        simulation.stop()-->
<!--                        fixed(true)-->
<!--                    }-->
<!--                }-->

<!--                // drag nodes-->
<!--                function dragstarted(d) {-->
<!--                    if (positioning === 'map') { return }-->
<!--                    simulation.alphaTarget(0.3).restart()-->
<!--                    d.fx = d.x-->
<!--                    d.fy = d.y-->
<!--                }-->

<!--                function dragged(d) {-->
<!--                    if (positioning === 'map') { return }-->
<!--                    d.fx = d3.event.x-->
<!--                    d.fy = d3.event.y-->
<!--                    fix_nodes(d);-->
<!--                }-->

<!--                function dragended(d) {-->
<!--                    if (positioning === 'map') { return }-->
<!--                    simulation.alphaTarget(0)-->
<!--                    d.fx = d.x-->
<!--                    d.fy = d.y-->
<!--                }-->

<!--                // Preventing other nodes from moving while dragging one node-->
<!--                function fix_nodes(this_node) {-->
<!--                  nodes.each(function(d) {-->
<!--                    if (this_node != d) {-->
<!--                      d.fx = d.x;-->
<!--                      d.fy = d.y;-->
<!--                    }-->
<!--                  });-->
<!--                }-->

<!--                svg.call(zoom)-->
<!--            }-->


        </script>

        <!-- Menu Toggle Script -->
        <script>
          divChild = document.getElementById("#menu-toggle1");
          $(divChild).click(function(e) {
            e.preventDefault();
            divChild2 = document.getElementById("#wrapper");
            $(divChild2).toggleClass("toggled");
          });
        </script>
    </body>