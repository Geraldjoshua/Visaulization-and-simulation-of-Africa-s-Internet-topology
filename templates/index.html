<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <!-- JQuery -->
    <script crossorigin="anonymous"
            integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <!-- Bootstrap core CSS -->
    <link crossorigin="anonymous" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
          integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" rel="stylesheet">
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script src="//maps.googleapis.com/maps/api/js?key=AIzaSyAdUAqT9PRkg6x1mswnL-USnLjpgqDLxaA&callback"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/4.2.2/d3.min.js"></script>
    <script type="text/javascript" src="http://code.jquery.com/jquery-1.8.1.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
    <link href="{{ url_for('static', filename='style.css') }}" rel="stylesheet">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <style>
      #svg1 {
      width: 1100;
      height: 600;
      margin: 0;
      padding: 0;
      }
      .stations, .stations svg {
      position: absolute;
      }
      .stations line {
      position: relative;
      stroke: black;
      stroke-width: 2px;
      }
      .links {
      //width: 100%;
      //height: 100%;
      position: relative;
      }
      .stations circle {
      fill: brown;
      stroke: black;
      stroke-width: 1.5px;
      }
      .stations svg {
      width: 1000px;
      height: 1500px;
      padding-right: 100px;
      font: 10px sans-serif;
      }
      #toggle {
      position: absolute;
      right: 15px; top: 15px;
      z-index: 100;
      }
      .map path {
      fill: #eee;
      stroke: #fff;
      stroke-width: 2;
      }
      .container-fluid {
      overflow: hidden;
      }
      .links line {
      stroke: red;
      stroke-opacity: 0.25;
      }
      .nodes circle {
      fill: #679;
      stroke: #235;
      stroke-width: 1.5;
      }
      div.tooltip {
      color: #222;
      background: #fff;
      border-radius: 3px;
      box-shadow: 0px 0px 2px 0px #a6a6a6;
      padding: .2em;
      text-shadow: #f5f5f5 0 1px 0;
      opacity: 0.9;
      position: fixed;
      }
      .background {
      fill: none;
      pointer-events: all;
      }
      #states {
      fill: #aaa;
      }
      #state-borders {
      fill: none;
      stroke: #000;
      stroke-width: 1.5px;
      stroke-linejoin: round;
      stroke-linecap: round;
      pointer-events: none;
      }
    </style>
</head>
<body>
    <!-- Page Content -->
    <div id="page-content-wrapper">

        <nav class="navbar navbar-expand-lg navbar-light bg-light border-bottom">
            <ul class="navbar-nav mr-auto mt-2 mt-lg-0">
                <li class="nav-item active">
                    <label for="platforms">platform chosen: speedchecker</label>
                    <div class="btn-group" id="platforms">
                      <button class="btn btn-secondary btn-sm dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        choose platforms
                      </button>
                      <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                        <a class="dropdown-item" href="speed">Speedchecker</a>
                        <a class="dropdown-item" href="ripe">RIPE</a>
                        <a class="dropdown-item" href="caida">CAIDA</a>
                      </div>
                    </div>
                    <div class="btn-group">
                        <a href=simulate><button class="btn btn-primary" id="menu-toggle">Simulation</button></a>
                    </div>


                </li>
            </ul>
        </nav>
        <div class="container-fluid" id="tooltip">
            <div id="map" style="width:100%;height:500px;"></div>
        </div>
    </div>
    <!-- /#page-content-wrapper -->
</div>
<script>

    // Create the Google Mapâ€¦
    var dat = {{data|tojson}}
    var paths = {{paths|safe}}
    var data = [];
    var datalinks = [];
    data = dat[1];
    datalinks = dat[0];
    city_data = dat[2]
    var nodes = [];
    var links = [];
    var map = new google.maps.Map(document.getElementById('map'), {
        zoom: 3,
        center: new google.maps.LatLng(34.5085, 8.7832),
        //mapTypeId: google.maps.MapTypeId.TERRAIN
    });

    class Node {
        constructor(asn_number, city, pos) {
            this.asn_number = asn_number;
            this.city = city;
            this.pos = pos;
        }
    }

    class CityNode {
      constructor(city, asn_list, pos){
        this.city = city;
        this.asn_list = asn_list;
        this.pos = pos;
      }
    }

    class Link {
        constructor(node1, node2,time) {
            this.source = node1;
            this.target = node2;
            this.rtt = time;
        }
    }

    var k;

    var city_nodes = []; //Nodes Array
    var pop_nodes = [];
    let city_markers = [];
    let pop_markers = [];
    let city_links = [];
    let pop_links = [];

    // window.onload = ready(data,datalinks);
    // function ready(data,datalinks) {

    //     draw(data,datalinks);

    // }

    window.onload = ready_city(city_data, datalinks);
    function ready_city(city_data,datalinks) {
        draw_city(city_data,datalinks);

    }

    function ready_pop(data,datalinks) {
        draw_pop(data,datalinks);

    }

    function makeMarker(position, name, color){
      var marker = new google.maps.Marker({
          position: position,
          sName: name,
          map: map,
          // icon: {
          //     path: google.maps.SymbolPath.CIRCLE,
          //     scale: 2.5,
          //     fillColor: color,
          //     fillOpacity: 0.4,
          //     strokeWeight: 0.4
          // },
      });

      marker.addListener("click", () => {
        info_wind = returnPopup(name);
        info_wind.open(map, marker);
      });
      return marker;
      //markers.push(marker);
    }

    function returnPopup(text){
      const contentString = 
          '<div><p>Name of City is '+text+'</p></div>';
      const infowindow = new google.maps.InfoWindow({
        content: contentString
      });
      return infowindow;
    }

    function makePolyline(flightPlanCoordinates, color){
      var flightPath = new google.maps.Polyline({
        path: flightPlanCoordinates,
        geodesic: true,
        strokeColor: color,
        strokeOpacity: 1.0,
        strokeWeight: 1
      });
      //links.push(flightPath);
      flightPath.setMap(map);
      return flightPath;
    }

    function draw_pop(data,datalinks) {
          var b;
          //data = nodes, datalinks = links
          for(b =0; b<data.length; b++){
                var lat= data[b].Latitude;
                var long= data[b].Longitude;
                var latLng = {lat: parseFloat(lat), lng: parseFloat(long)};
                nodes[b] = latLng;
                var  asnnumber = data[b].ASN;
                var city = data[b].City;
                city = city.replace('\n', '')
                var ip = "111.111.111.0" //data[b].IP
                var newnode = new Node(asnnumber, city, latLng);
                pop_nodes.push(newnode);
                marker = makeMarker(latLng, data[b].ASN, "#F00");
                pop_markers.push(marker);
          }
          var p;
          var num_links = 0;
          for(p=0; p<datalinks.length; p++){
               var source;
               var target;
               var j;

               for(j=0; j<pop_nodes.length;j++){
                    if(datalinks[p].Source_ASN == pop_nodes[j].asn_number && datalinks[p].Source_City == pop_nodes[j].city){
                      //console.log("here now");
                      source = pop_nodes[j].pos;
                    }

                    if(datalinks[p].Target_ASN == pop_nodes[j].asn_number && datalinks[p].Target_City == pop_nodes[j].city){
                      target = pop_nodes[j].pos;
                    }
               }

              var flightPlanCoordinates = [
                  source,target
                ];
              var new_link = new Link(source, target);
              linkLine = makePolyline(flightPlanCoordinates, '#FF0000');
              pop_links.push(linkLine);
              num_links = num_links+1;
          }
          //console.log(num_links);
    }

    //function to draw City level nodes
    function draw_city(data, datalinks){
      var b;
          //data = nodes, datalinks = links
          for(b =0; b<data.length; b++){
                var lat= data[b].Latitude;
                var long= data[b].Longitude;
                var latLng = {lat: parseFloat(lat), lng: parseFloat(long)};
                nodes[b] = latLng;
                var city = data[b].City;
                city = city.replace('\n', '')
                var newnode = new CityNode(city, [12, 23], latLng);
                city_nodes.push(newnode);
                marker = makeMarker(latLng, data[b].City, "#3a00cc");
                city_markers.push(marker);
          }
          var p;
          var num_links = 0;
          for(p=0; p<datalinks.length; p++){
               var source;
               var target;
               var j;

               for(j=0; j<city_nodes.length;j++){
                    if( datalinks[p].Source_City == city_nodes[j].city){
                      //console.log("here now");
                      source = city_nodes[j].pos;
                    }

                    if(datalinks[p].Target_City == city_nodes[j].city){
                      target = city_nodes[j].pos;
                    }

               }

                var flightPlanCoordinates = [
                    source,target
                  ];
                var new_link = new Link(source, target);
                linkLine = makePolyline(flightPlanCoordinates, '#3a00cc');
                city_links.push(linkLine);
                num_links = num_links+1;
          }
          console.log(num_links);
    }

    // Sets the map on all markers in the array.
    function setMapOnAll(map=null, nodeType) {
      if(nodeType=="City"){
        for (let i = 0; i < city_markers.length; i++) {
          city_markers[i].setMap(map);
        }
      }else{
        for (let i = 0; i < pop_markers.length; i++) {
          pop_markers[i].setMap(map);
        }
      }
    }

    // Sets the map on all links in the array.
    function setMapOnLinks(map=null, nodeType) {
      if(nodeType=="City"){
        for (let i = 0; i < city_links.length; i++) {
          city_links[i].setMap(map);
        }
      }else{
        for (let i = 0; i < pop_links.length; i++) {
          pop_links[i].setMap(map);
        }
      }
    }

    // Removes the markers from the map, but keeps them in the array.
    function clearMarkers(nodeType) {
      setMapOnAll(null, nodeType);
    }

    // Removes the links from the map, but keeps them in the array.
    function clearLinks(nodeType) {
      setMapOnLinks(null, nodeType);
    }

    var infowindow = new google.maps.InfoWindow({
      content: 'Change the zoom level',
      position: new google.maps.LatLng(34.5085, 8.7832),
    });
    infowindow.open(map);

    map.addListener('zoom_changed', function() {
      infowindow.setContent('Zoom: ' + map.getZoom());
      if(map.getZoom()>=6){
        clearMarkers("City");
        clearLinks("City");
        if(pop_links.length==0){
          //means the POP map has not been drawn yet
          ready_pop(data, datalinks);
        } else {
          setMapOnAll(map, "POP");
          setMapOnLinks(map, "POP");
        }
        //load the PoP level map  
      } else{
        clearMarkers("POP");
        clearLinks("POP");
        setMapOnAll(map, "City");
        setMapOnLinks(map, "City");
      }
    });

    function animateCircle(line) {
        var count = 0;
        window.setInterval(function() {
          count = (count + 1) % 200;

          var icons = line.get('icons');
          icons[0].offset = (count / 2) + '%';
          line.set('icons', icons);
        }, 20);
    }


</script>
</body>
